{% load custom_tags %}

</br>
<h6>Scales :</h6>
<ul class="nav nav-pills flex-column flex-sm-row border" id="stats-comVsInd-pills-tab" role="tablist">
  {% with exam.scales.all|first as first_scale %}
  {% for scale in exam.scales.all %}
  {% if scale.pk == first_scale.pk %}
  <li class="nav-item" role="presentation">
    <a class="flex-sm-fill text-sm-center nav-link active" id="comVsInd-{{ scale.pk }}-tab" data-toggle="pill" href="#pills-comVsInd-{{ scale.pk }}" role="tab" aria-controls="pills-comVsInd-{{ scale.pk }}" aria-selected="true">{{ scale.name }}{% if scale.final %} <i class="fa-solid fa-circle-check fa-xs"></i>{% endif %}</a>
  </li>
  {% else %}
  <li class="nav-item" role="presentation">
    <a class="flex-sm-fill text-sm-center nav-link" id="comVsInd-{{ scale.pk }}-tab" data-toggle="pill" href="#pills-comVsInd-{{ scale.pk }}" role="tab" aria-controls="pills-comVsInd-{{ scale.pk }}" aria-selected="false">{{ scale.name }}{% if scale.final %} <i class="fa-solid fa-circle-check fa-xs"></i>{% endif %}</a>
  </li>
  {% endif %}
  {% endfor %}
  {% endwith %}
</ul>
<div class="tab-content" id="stats-comVsInd-pills-tabContent">
  {% with exam.scales.all|first as first_scale %}
  {% for scale in exam.scales.all %}
  {% if scale.pk == first_scale.pk %}
  <div class="tab-pane fade show active" id="pills-comVsInd-{{ scale.pk }}" role="tabpanel" aria-labelledby="pills-comVsInd-{{ scale.pk }}-tab">
  {% else %}
  <div class="tab-pane fade" id="pills-comVsInd-{{ scale.pk }}" role="tabpanel" aria-labelledby="pills-comVsInd-{{ scale.pk }}-tab">
  {% endif %}
    </br>
    <ul class="nav nav-pills flex-column flex-sm-row border" id="stats-comVsInd-sub_pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="flex-sm-fill text-sm-center nav-link active" id="comVsInd-{{ scale.pk }}-teachers-tab" data-toggle="pill" href="#pills-comVsInd-{{ scale.pk }}-teachers" role="tab" aria-controls="pills-comVsInd-{{ scale.pk }}-teachers" aria-selected="true">by Teacher</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="flex-sm-fill text-sm-center nav-link" id="comVsInd-{{ scale.pk }}-sections-tab" data-toggle="pill" href="#pills-comVsInd-{{ scale.pk }}-sections" role="tab" aria-controls="pills-comVsInd-{{ scale.pk }}-sections" aria-selected="false">by Section</a>
      </li>
    </ul>
    <div class="tab-content" id="stats-comVsInd-pills-sub-tabContent" style="max-height:75vh;overflow-y:scroll;">
      <div class="tab-pane fade show active" id="pills-comVsInd-{{ scale.pk }}-teachers" role="tabpanel" aria-labelledby="pills-comVsInd-{{ scale.pk }}-teachers-tab" style="max-width:80%;">
        <div class="table-responsive">
        {% with exam|get_teachers_comVsInd_scaleStats_by_overall_examScale:scale as teachers_stats %}
          </br>
          <table id="comVsInd_teachers_dt{{ scale.pk }}" class="table table-striped table-sm">
            <thead>
              <tr>
                <th>Teacher</th>
                <th>Average points common {{ teachers_stats.first.com_rate|floatformat:2 }}%</th>
                <th>Average grade common {{ teachers_stats.first.com_rate|floatformat:2 }}%</th>
                <th>Average points indiv {{ 100|substract:teachers_stats.first.com_rate|floatformat:2 }}%</th>
                <th>Average grade indiv {{ 100|substract:teachers_stats.first.com_rate|floatformat:2 }}%</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in teachers_stats  %}
              <tr>
                <th>{{ stat.exam.primary_user.last_name }}</th>
                <th>{{ stat.com_avg_pts }}</th>
                <th>{{ stat.com_avg_grade }}</th>
                <th>{{ stat.ind_avg_pts }}</th>
                <th>{{ stat.ind_avg_grade }}</th>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endwith %}
        </div>
        <canvas id="canvas-comVsIndByTeacher-{{ scale.pk }}" class="chartjs-render-monitor" style="object-fit: contain;"></canvas>
      </div>
      <div class="tab-pane fade" id="pills-comVsInd-{{ scale.pk }}-sections" role="tabpanel" aria-labelledby="pills-comVsInd-{{ scale.pk }}-sections-tab" style="max-width:80%;">
        <div class="table-responsive">
        {% with exam|get_sections_comVsInd_scaleStats_by_overall_examScale:scale as sections_stats %}
          </br>
          <table id="comVsInd_sections_dt{{ scale.pk }}" class="table table-striped table-sm">
            <thead>
              <tr>
                <th>Section</th>
                <th>Average points common {{ sections_stats.first.com_rate|floatformat:2 }}%</th>
                <th>Average grade indiv {{ sections_stats.first.com_rate|floatformat:2 }}%</th>
                <th>Average points indiv {{ 100|substract:sections_stats.first.com_rate|floatformat:2 }}%</th>
                <th>Average grade common {{ 100|substract:sections_stats.first.com_rate|floatformat:2 }}%</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in sections_stats %}
              <tr>
                <th>{{ stat.section }}</th>
                <th>{{ stat.com_avg_pts }}</th>
                <th>{{ stat.com_avg_grade }}</th>
                <th>{{ stat.ind_avg_pts }}</th>
                <th>{{ stat.ind_avg_grade }}</th>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endwith %}
        <canvas id="canvas-comVsIndBySection-{{ scale.pk }}" class="chartjs-render-monitor" style="object-fit: contain;"></canvas>
      </div>
    </div>
  </div>
  {% endfor %}
  {% endwith %}
</div>
