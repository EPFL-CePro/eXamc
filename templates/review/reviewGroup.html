{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block extra_head %}

<script type="text/javascript"  src="https://cdnjs.cloudflare.com/ajax/libs/jquery.textcomplete/1.8.0/jquery.textcomplete.js"></script>
<script type="text/javascript" src="{% static 'js/jquery-comments.js' %}"></script>
<script type="text/javascript" src="https://unpkg.com/markerjs2/markerjs2.js"></script>
    
<script type="text/javascript" src="{% static 'js/jspolygon.js' %}"></script>
    
<!-- MathJax -->
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js">
</script>
<link rel="stylesheet" type="text/css" href="{% static 'css/jquery-comments.css' %}">

{% endblock %}

{% block title %}Review {{ pages_group }}{% endblock %}
{% block scripts %}
  
    

 
{% endblock %}

{% block content %}
{% if user.pk|is_review_blocked:exam_selected.pk %}
    <div class="alert alert-warning" role="alert">
        You are currently blocked for Review! <br><br> Please contact the teacher to be unblocked.
    </div>
{% else %}
    {%  if copies_pages_list %}
    <div class="row" style="height:50px;">
        <div class="column" style="width:300px;margin-left:15px;">
            <a href="{% url 'reviewView' exam_selected.pk %}" class="btn btn-outline-dark btn-sm"><i class="fas fa-arrow-left fa-lg" style="margin-right:10px;"></i>Back to Summary</a>
        </div>
        <div class="column" style="margin-left:50px;">
            <h3><i class="fas fa-glasses fa-l" style="margin-right:10px;"></i>Review {{ pages_group.group_name }}</h3>
        </div>
    </div>
        <div>

        </div>
    <style>
    :focus { outline: none; }
    </style>
    <div id="reviewGroup_div" class="d-flex" tabindex="0" style="height:93vh;">


        <div id="pages_group_list" style="background-color:#f1f1f1;">
            <a id="expandCollapseGroupListBt" type="button" data-bs-toggle="collapse" style="margin:5px 5px 5px 5px;float:right;" data-bs-target="#pages_group_list_table_div" aria-expanded="True" aria-controls="pages_group_list_table_div">
                <i id="expand-group-list-icon" class="fa-lg" style="color:grey;"></i>
                <i id="collapse-group-list-icon" class="fa mr-3 fa-angle-double-left" style="color:grey;"></i>
            </a>
            <div id="pages_group_list_table_div" class="collapse collapse-horizontal show">
                <table class="table table-striped table-sm" id="table-copies-pages">
                    <thead>
                    <tr>
                        <th></th>
                        <th>id</th>
                        <th>Copy</th>
                        <th>Page</th>
                        <th>Graded</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for page in copies_pages_list %}
                    <tr id="copy_{{page.copy_no}}_{{page.page_no}}">
                        <td>
                            <i id="copy_{{page.copy_no}}_{{page.page_no}}_id" name="{{ forloop.counter }}" class="fa-solid fa-lock fa-xs" style="display:None; color: #df8134;"></i>
                        </td>
                        <td style="text-align:left;">
                            {{ forloop.counter }}
                        </td>
                        <td style="text-align:left;">{{ page.copy_no }}</td>
                        <td style="text-align:center;">{{ page.page_no }}</td>
                        <td id="copy_{{page.copy_no}}_{{page.page_no}}_marked" >{% if page.marked %}<i class="fa-solid fa-circle-check fa-lg"
                                                   style="padding-left:25px;">{% endif %}</i></td>
                        <td>
                            {% if page.comment %}
                            <i class="fas fa-comments fa-lg"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="list-group" id="test" style="height:100%;margin-left:5px;width:60vw;position:relative;" >
            <div id="pagination" class="list-group list-group-horizontal"></div>
            <div id="copy_page_select" style="z-index:99;position:absolute;margin-top:100px;right:20px;background-color: gray;padding:2px;"></div>
            <div id="markerjs_div" style="height:95%;aspect-ratio:1/1.49;overflow-y: auto;border:1px solid lightgrey;padding-top:5px;">
                <div class="col-xs-6" style="position: relative; display: flex; flex-direction: column;">
                    <img id="source_img" style=""/>
                    <img id="marked_img" style="max-width:100%;position: absolute;"/>
                    <div id="corr_box_div" style="position:absolute;z-index:999;">
                        <svg id="corrector_boxes_svg" style="width:100%;height:100%;">

                        </svg>
                    </div>

                </div>
            </div>
        </div>
        <div>
            <p style="margin-right:20px;margin-top:10px;">
                <a title="Discussion"
                   class="js-toggle-comments"
                   type="button"
                   data-bs-toggle="modal"
                   style="float:right;"
                   data-bs-target="#commentsModal"
                   aria-expanded="false"
                   aria-controls="comments-div">
                    <i id="comment-icon" class="fas fa-comments fa-2x" style="margin-left:10px;"></i>
                </a>
            </p>
            {% if pages_group.use_grading_scheme %}
                <div id="grading-scheme-div" style="background-color:#f1f1f1;padding:20px;margin-top:-20px;">
                    <h6>Grading Schemes</h6>

                    <ul class="nav nav-pills flex-column flex-md-row border" id="review-scheme-pills">
                        {% for gs in grading_schemes %}
                            <li class="nav-item" role="presentation">
                                <a type="button"
                                   id="review-scheme-link-{{ gs.id }}"
                                   class="nav-link js-scheme-link {% if current_grading_scheme and current_grading_scheme.id == gs.id %}active{% endif %}"
                                   aria-selected="{% if current_grading_scheme and current_grading_scheme.id == gs.id %}true{% else %}false{% endif %}"
                                   data-exam-id="{{ exam_selected.id }}"
                                   hx-trigger="never"
                                   data-hx-get="{% url 'review_grading_scheme_panel' exam_selected.id gs.id 0 %}"
                                   onclick="return sendScheme(this, event)">
                                    {{ gs.name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                    <div id="review-scheme-panel" class="tab-content"></div>
                </div>
            {% endif %}
        </div>
    </div>
        <div class="modal" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header handle">
                        <h5 class="modal-title" id="commentsModalLabel">
                            <i class="fas fa-comments fa-lg"></i> Discussion
                        </h5>
                    </div>
                    <div class="modal-body p-0">
                        <div id="comments-container" style="padding:5px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    <script>
    $('.modal-dialog').draggable();


        window.MathJax = {
            tex: {
                inlineMath: [['$$', '$$'], ['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],

            }
        };
        let sourceImage, markedImage, targetRoot, maState, currSourceElementId, currSourceIdSplit, markerArea,
            from_copy_orig_id;
        let group_copies_pages_list = JSON.parse('{{json_copies_pages_list|safe }}');
        let current_grading_scheme_id;

        window.addEventListener('resize', function (event) {
            location.reload();
        }, true);

        // save references to the original image and its parent div (positioning root)
        function setSourceImage(source) {
            sourceImage = source;
            targetRoot = source.parentElement;
        }

        function createPagination(pages, page) {


            let str = ''//'<ul class="list-group list-group-horizontal">';

            //setSourceScan(group_copies_pages_list[page-1]["path"],false);
            {##### TESTING DISPLAYING FULL COPIE JPGS #####}
            {#setSourceScan(group_pathes_new[page-1]["path"],group_pathes[page-1]["path"], "");#}
            {##### END TESTING DISPLAYING FULL COPIE JPGS #####}

            // Show the Previous button only if you are on a page other than the first
            if (page > 1) {
                str += '<a id="previous_page" class="list-group-item list-group-item-action" onclick="createPagination(' + pages + ', ' + (page - 1) + ')">Previous</a>';
            }

            // Show the very first page followed by a "..." at the beginning of the
            // pagination section (after the Previous button)
            if (page > 1) {
                str += '<a class="list-group-item list-group-item-action" onclick="createPagination(' + pages + ', 1)">1</a>';
                if (page > 2) {
                    str += '<a class="list-group-item list-group-item-action" onclick="createPagination(' + pages + ',' + (page - 2) + ')">...</a>';
                }
            }
            // Determine how many pages to show after the current page index
            if (page === 1) {
                <!-- pageCutHigh += 1; -->
            } else if (page === 2) {
                <!-- pageCutHigh += 0; -->
            }
            // Determine how many pages to show before the current page index
            if (page === pages) {
                <!-- pageCutLow -= 1; -->
            } else if (page === pages - 1) {
                <!-- pageCutLow -= 0; -->
            }
            // active page
            str += '<a class="list-group-item list-group-item-action active" onclick="createPagination(' + pages + ', ' + page + ')">' + page + '</a>';

            // Show the very last page preceded by a "..." at the end of the pagination
            // section (before the Next button)
            if (page < pages - 1) {
                if (page < pages - 2) {
                    str += '<a class="list-group-item list-group-item-action" onclick="createPagination(' + pages + ',' + (page + 2) + ')">...</a>';
                }
                str += '<a class="list-group-item list-group-item-action" onclick="createPagination(' + pages + ',' + pages + ')">' + pages + '</a>';
            }
            // Show the Next button only if you are on a page other than the last
            if (page < pages) {
                str += '<a id="next_page" class="list-group-item list-group-item-action" onclick="createPagination(' + pages + ',' + (page + 1) + ')">Next</a>';
            }

            // Return the pagination string to be outputted in the pug templates
            document.getElementById("pagination").innerHTML = str;

            copy_no = group_copies_pages_list[page - 1]["copy_no"];
            page_no = group_copies_pages_list[page - 1]["page_no"];
            if (setMarkerArea(copy_no, page_no)) {
                // hide HiglightMarker if visible (marker used for corrector boxes but not available for reviewers
                hl_marker_elements = document.querySelectorAll('[data-type-name="HighlightMarker"]');
                for (el of hl_marker_elements) {
                    el.style = "display:none;";
                }
            } else {
                if (page < pages) {
                    createPagination(pages, page + 1);
                } else {
                    createPagination(pages, 1);
                }
            }
        }

        function setSourceScan(scan_path, from_copy) {
            if (from_copy) {
                lastSourceIdSplit = old_source.split('_');
                from_copy_orig_id = lastSourceIdSplit[0] + "_" + lastSourceIdSplit[1] + "_" + lastSourceIdSplit[2];
            }
            src_url = "/" + scan_path.split('/')[1] + "/" + scan_path.split('/')[3];
            old_source = document.getElementById("source_img").alt;
            sourceImage = document.getElementById("source_img");
            sourceImage.src = src_url
            sourceImage.alt = scan_path.split("/")[2]
            targetRoot = sourceImage.parentElement;
            old_marked = document.getElementById("marked_img").src;
            markedImage = document.getElementById("marked_img");
            markedImage.src = src_url;

            // change current and last source element background color
            currSourceIdSplit = scan_path.split("/")[2].split('_');
            //currSourceIdSplit = scan_path.replace(/\/+$/, '').split('/').pop().split('.jpg')[0].split('_');
            currSourceElementId = currSourceIdSplit[0] + "_" + currSourceIdSplit[1] + "_" + currSourceIdSplit[2];

            if (!from_copy) {
                currEl = document.getElementById(currSourceElementId)
                currSourceIdSplit.push(document.getElementById(currSourceElementId).cells[0].innerText);
            }
            if (old_source && !from_copy) {
                if (from_copy_orig_id !== null) {
                    lastSourceElementId = from_copy_orig_id;
                    from_copy_orig_id = null;
                } else {
                    lastSourceElementId = old_source;
                }

                lastEl = document.getElementById(lastSourceElementId);
                if (lastEl) {
                    lastEl.style.backgroundColor = "";
                }
            }
            if (!from_copy) {
                document.getElementById(currSourceElementId).style.backgroundColor = "yellow";
            }

        }

        function setMarkerArea(copy_no, page_no, from_copy = false) {

            result_ok = getMarkersAndComments("{{ exam_selected.pk }}", copy_no, page_no, from_copy);//,sourceImage.getAttribute("src"));
            if (markerArea) {
                markerArea.close();
                delete markerArea;
            }
            markerArea = new markerjs2.MarkerArea(sourceImage);
            markerArea.uiStyleSettings.redoButtonVisible = true;
            markerArea.uiStyleSettings.notesButtonVisible = true;
            markerArea.uiStyleSettings.zoomButtonVisible = true;
            markerArea.uiStyleSettings.zoomOutButtonVisible = true;
            markerArea.uiStyleSettings.clearButtonVisible = true;
            markerArea.uiStyleSettings.resultButtonBlockVisible = false;
            markerArea.uiStyleSettings.notesButtonVisible = false;
            markerArea.settings.defaultColorSet = ['#ac0000', 'black', 'blue'];
            markerArea.settings.defaultFillColor = '#ac0000';
            markerArea.settings.defaultStrokeColor = '#ac0000';
            markerArea.settings.newFreehandMarkerOnPointerUp = true;
            markerArea.availableMarkerTypes = ['FreehandMarker', 'HighlightMarker', 'TextMarker'];//'LineMarker','RectangleMarker','EllipseMarker','CoverMarker','EllipseFrameMarker',...markerArea.BASIC_MARKER_TYPES,'CalloutMarker',];

            // since the container div is set to position: relative it is now our positioning root
            // end we have to let marker.js know that
            markerArea.targetRoot = targetRoot;

            markerArea.addEventListener("render", (event) => {
                markedImage.src = event.dataUrl;
                // save the state of MarkerArea
                //maState = event.state;
                //updateMarkers(markerArea,"{{ exam_selected.pk }}","{{ pages_group.pk }}");
            });

            markerArea.addEventListener("close", (event) => {
                //setMarkerArea(copy_no,page_no);
            });

            //get Markers (state) if exist
            {#imgsrc_split = sourceImage.src.split('/').pop().split('.').slice(-2)[0].split('_');#}
            {#copy_no = currSourceIdSplit[1];#}
            {#page_no = currSourceIdSplit[2];#}
            {#result_ok = getMarkersAndComments("{{ exam_selected.pk }}",copy_no,page_no);//,sourceImage.getAttribute("src"));#}
            if (result_ok) {

                markerArea.show();
                // if previous state is present - restore it
                if (maState) {
                    markerArea.restoreState(maState);
                }

                markerArea.addEventListener("markerdeselect", (event) => {
                    markerChange();
                });

                markerArea.addEventListener("markerdelete", (event) => {
                    markerChange();
                });

                return true;

            } else {
                return false;
            }

        }

        function markerChange() {
            svgData = new XMLSerializer().serializeToString(markerArea.markerImage);
            svgDataBase64 = btoa(unescape(encodeURIComponent(svgData)));
            svgDataUrl = `data:image/svg+xml;charset=utf-8;base64,${svgDataBase64}`;

            addMarkersImageProcess(svgDataUrl).then(img => {
                var canvas = document.createElement('canvas')

                canvas.setAttribute('width', markerArea.target.naturalWidth)
                canvas.setAttribute('height', markerArea.target.naturalHeight)

                var context = canvas.getContext('2d')
                context.drawImage(markerArea.target, 0, 0, markerArea.target.naturalWidth, markerArea.target.naturalHeight)
                context.drawImage(img, 0, 0, markerArea.target.naturalWidth, markerArea.target.naturalHeight)
                var dataUrl = canvas.toDataURL('image/jpeg')
                markedImage.src = dataUrl;
                updateMarkers(markerArea, "{{ exam_selected.pk }}", "{{ pages_group.pk }}");
            });
        }

        function addMarkersImageProcess(src) {
            return new Promise((resolve, reject) => {
                let img = new Image()
                img.onload = () => resolve(img)
                img.onerror = reject
                img.src = src
            })
        }

        function initCopyPagesSelectpicker(pages, curr_page) {
            const selectElDiv = document.getElementById('copy_page_select');
            selectElDiv.innerHTML = "";
            const selectEl = document.createElement('select');
            selectEl.className = 'selectpicker form-control';
            selectEl.style.width = '100px'
            pages.forEach(pageData => {
                const optionEl = document.createElement('option');
                optionEl.value = pageData.copy_no + "-" + pageData.page_no;
                optionEl.textContent = "page " + pageData.page_no;
                if (Number(curr_page) === Number(pageData.page_no)) {
                    optionEl.selected = true;
                }
                selectEl.appendChild(optionEl);
            })
            selectEl.addEventListener('change', () => {
                copy_nr = selectEl.value.split('-')[0]
                page_nr = selectEl.value.split('-')[1]
                changeCopyPage({{ pages_group.exam.pk }}, copy_nr, page_nr);
            });
            selectElDiv.append(selectEl);
            $('.selectpicker').selectpicker();
        }

        function changeCopyPage(exam_pk, copy_no, page_no) {
            $.ajax({
                url: "{% url 'get_copy_page' exam_selected.pk %}",
                type: "POST",
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'copy_no': copy_no,
                    //'curr_row': curr_row,
                    'page_no': page_no,
                },
                success: (copyPageUrl) => {
                    setMarkerArea(copy_no, page_no, true);
                },
            });
        }

        function getMarkersAndComments(pk, copy_no, page_no, from_copy = false) {
            result = false;
            var markers;
            $.ajax({
                url: "{% url 'review_student_pages_group_is_locked' exam_selected.pk %}",
                async: false,
                type: "POST",
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'pages_group_id': {{ pages_group.id }},
                    'copy_no': copy_no,
                },
                success: (data) => {
                    if (data === '') {
                        td_el = document.getElementById('copy_' + copy_no + '_' + Number(page_no) + '_id');
                        if (td_el) {
                            td_el.style.display = 'None';
                        }
                        //td_el = document.getElementById('copy_'+copy_no+'_'+Number(page_no)+'_id');
                        //td_el.innerText=td_el.getAttribute('name');
                        $.ajax({
                                url: "{% url 'get_markers_and_comments' exam_selected.pk %}",
                                async: false,
                                type: "POST",
                                data: {
                                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                                    'copy_no': copy_no,
                                    'page_no': "" + page_no,
                                    //'filename' : filename,
                                    'group_id': {{ pages_group.id }}
                                },
                                success: (data) => {
                                    markers = "None";
                                    if (data != "None") {
                                        data_full = JSON.parse(data);

                                        setSourceScan(data_full.copyPageUrl, from_copy);

                                        maState = JSON.parse(data_full.markers);
                                        comments = data_full.comments;
                                        corrector_boxes = JSON.parse(data_full.corrector_boxes);
                                        $("#corrector_boxes_svg").empty();
                                        $("#corr_box_div").css("display", "none");
                                        if (corrector_boxes.length > 0) {
                                            $("#corr_box_div").css("display", "block");
                                            setTimeout(() => {
                                                draw_corrector_boxes(corrector_boxes);
                                            }, 300);
                                            //draw_corrector_boxes(corrector_boxes);
                                        }
                                        initComments(comments);
                                        pages = JSON.parse(data_full.copy_pages);
                                        initCopyPagesSelectpicker(pages, page_no);

                                        //Refresh grading scheme panel
                                        const active = document.querySelector('a[id^="review-scheme-link-"].active') || document.querySelector('a[id^="review-scheme-link-"]');
                                        if (active) {
                                            setTimeout(() => sendScheme(active), 0);
                                        }

                                    }
                                    result = true;
                                },
                                error: (error) => {
                                    console.log(error);
                                }
                            }
                        );
                    } else {
                        td_el = document.getElementById('copy_' + copy_no + '_' + Number(page_no) + '_id');
                        td_el.style.display = 'block';// '<i class="fa-solid fa-lock" style="color: #df8134;"><a style="font-weight: normal;color:#626262;">'+td_el.getAttribute('name')+'<\i>';
                        //td_el.innerHTML=inner_html;
                        result = false;
                    }

                },
                    error:
                        (error) => {
                            console.log(error);
                        }
                }
            )
            return result;
        }

        function draw_corrector_boxes(data) {
            //add rect box corrector
            corrector_boxes_svg = document.getElementById('corrector_boxes_svg');
            var svgns = "http://www.w3.org/2000/svg";

            imgRatio = sourceImage.naturalHeight / sourceImage.height;

            const corr_box_div = document.getElementById('corr_box_div');
            min_x = Math.min.apply(Math, data.map(function (event) {
                return event.x;
            }));
            min_y = Math.min.apply(Math, data.map(function (event) {
                return event.y;
            }));
            max_y = Math.max.apply(Math, data.map(function (event) {
                return event.y;
            }));
            x_pos = min_x / imgRatio - 10
            y_pos = min_y / imgRatio - 10
            pos_y_min = 0
            pos_y_max = 0
            for (let pos of data) {
                if (pos.y > pos_y_max) {
                    pos_y_max = pos.y;
                } else if (pos_y_min === 0 || pos.y < pos_y_min) {
                    pos_y_min = pos.y;
                }

                if (pos.corner === 1) {
                    pol_left = pos.x / imgRatio;
                    pol_top = pos.y / imgRatio;
                    var polygon = document.createElementNS(svgns, 'polygon');
                }
                var point = corrector_boxes_svg.createSVGPoint();
                point.x = (pos.x) / imgRatio - x_pos;
                point.y = pos.y / imgRatio - y_pos;
                polygon.points.appendItem(point)

                if (pos.corner == 2) {
                    pol_width = (pos.x / imgRatio) - pol_left;
                }

                if (pos.corner === 4) {
                    pol_height = (pos.y / imgRatio) - pol_top;
                    corrector_boxes_svg.appendChild(polygon);
                    polygon.setAttribute('fill', 'transparent');
                    polygon.setAttribute('stroke', 'purple');
                    polygon.setAttribute('stroke-width', '3');
                    polygon.setAttribute('opacity', '0.7');
                    polygon.setAttribute('data-bounds', pol_left + "," + pol_top + "," + pol_width + "," + pol_height);
                    if ('{{ pages_group.use_grading_scheme }}' !== 'True') {
                        polygon.setAttribute('onclick', "createMarker4CorrBox(" + pol_left + "," + pol_top + "," + pol_width + "," + pol_height + ");");
                    }
                }
            }
            corr_height = max_y / imgRatio - y_pos + 10;//pos_y_max - pos_y_min;
            corrector_boxes_svg.parentElement.setAttribute('style', "position:absolute;top:" + y_pos + "px;left:" + x_pos + "px;height:" + corr_height + "px;width:75%;z-index:999");
        }

        function createMarker4CorrBox(left, top, width, height) {

            new_marker = markerArea.addNewMarker(markerjs2.HighlightMarker);
            new_marker.left = left;
            new_marker.top = top;
            new_marker.width = width;
            new_marker.height = height;
            new_marker.fillColor = "black";
            new_marker.opacity = 1;
            new_marker.createVisual();
            push_marker = true
            for (i in markerArea.markers) {

                if (markerArea.markers[i].typeName === 'HighlightMarker') {
                    push_marker = false
                    if (markerArea.markers[i].left !== left || markerArea.markers[i].top !== top
                        || markerArea.markers[i].width !== width || markerArea.markers[i].height !== height) {
                        push_marker = true;
                    }
                    delete markerArea.markers[i];
                }
            }
            if (push_marker) {
                markerArea.markers.push(new_marker);
            }

            markerArea.maState = markerArea.getState();
            markerArea.restoreState(markerArea.getState())
            markerChange();
            //markerArea.restoreState(markerArea.getState());

        }

        function initCopyPagesTableOnClickRowEvent(refresh) {

            $("#table-copies-pages").off().on('click', 'tr', function () {
                createPagination({{ copies_pages_list|length }}, parseFloat(this.cells[1].innerText));
            });

            if (!refresh) {
                var table = $("#table-copies-pages").DataTable({
                    scrollY: '85vh',
                    "dom": 'rtip',
                    "lengthChange": false,
                    "paging": false,
                });
            }
        }


        function updateMarkers(markerArea, exam_pk, pages_group_pk) {
            imgsrc_split = sourceImage.src.split('/').pop().split('.').slice(-2)[0].split('_');
            copy_no = currSourceIdSplit[1];
            page_no = currSourceIdSplit[2];
            id_no = currSourceIdSplit[3]

            saveMarkers(exam_pk, pages_group_pk, copy_no, page_no, JSON.stringify(markerArea.getState()), markedImage.src, sourceImage.getAttribute("src"), id_no);

            initCopyPagesTableOnClickRowEvent(true);
            currEl = document.getElementById(currSourceElementId)
            if (currEl) {
                currEl.style.backgroundColor = "yellow";
            }

        }

        function saveMarkers(pk, group_pk, copy_no, page_no, markers, marked_img_dataUrl, filename, curr_row) {
            $.ajax({
                url: "{% url 'save_markers' exam_selected.pk %}",
                type: "POST",
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'reviewGroup_pk': group_pk,
                    'curr_row': curr_row,
                    'copy_no': copy_no,
                    'page_no': "" + page_no,
                    'markers': markers,
                    'marked_img_dataUrl': marked_img_dataUrl,
                    'filename': filename
                },
                beforeSend: function () {
                },
                success: (marked) => {
                    marked_info_element = document.getElementById(currSourceElementId + "_marked");
                    if (marked_info_element) {
                        marked_info_element.innerHTML = "";
                        if (marked === 'True') {
                            marked_info_element.innerHTML = '<i class="fa-solid fa-circle-check fa-lg" style="padding-left:25px;">';
                        }
                    }

                },
            });
        }

        function saveComment(data) {
            copy_no = currSourceIdSplit[1];

            // Convert pings to human readable format
            $(Object.keys(data.pings)).each(function (index, userId) {
                var fullname = data.pings[userId];
                var pingText = '@' + fullname;
                data.content = data.content.replace(new RegExp('@' + userId, 'g'), pingText);
            });

            $.ajax({
                url: "{% url 'save_comment' exam_selected.pk %}",
                type: "POST",
                async: false,
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'comment': JSON.stringify(data),
                    'group_id': {{ pages_group.id }},
                    'copy_no': copy_no
                },
                success: (comment_id) => {
                    comments.slice(-1).id = comment_id;
                    data.id = comment_id;
                },
            });

            return data;
        }

        function deleteComment(data) {
            copy_no = currSourceIdSplit[1];

            $.ajax({
                url: "{% url 'save_comment' exam_selected.pk %}",
                type: "POST",
                async: false,
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'comment_id': data.id,
                    'group_id': {{ pages_group.id }},
                    'copy_no': copy_no,
                    'delete': true
                },
                success: (deleted) => {
                    {#comments.slice(-1).id = comment_id;#}
                    {#data.id = comment_id;#}
                },
            });

            return data;
        }

        function initComments(commentsArray) {
            $('#comments-container').comments({
                profilePictureURL: 'fa-solid fa-circle-user fa-2xs',
                currentUserId: {{ user.id }},
                roundProfilePictures: true,
                textareaRows: 1,
                enableAttachments: false,
                enableHashtags: false,
                enableUpvoting: false,
                enableEditing: true,
                enableDeleting: true,
                scrollContainer: $(window),
                getComments: function (success, error) {
                    setTimeout(function () {
                        success(commentsArray);
                    }, 500);
                },
                postComment: function (data, success, error) {
                    setTimeout(function () {
                        success(saveComment(data));

                    }, 500);
                },
                putComment: function (data, success, error) {
                    setTimeout(function () {
                        success(saveComment(data));
                    }, 500);
                },
                deleteComment: function (data, success, error) {
                    setTimeout(function () {
                        success(deleteComment(data));

                    }, 500);
                },
            });
        }

        $(window).on("load", function () {
            initCopyPagesTableOnClickRowEvent(false);
            {% if currpage > 0 %}
                createPagination({{ copies_pages_list|length }}, {{ currpage }});
            {% else %}
                document.getElementById("copy_{{copies_pages_list.0.copy_no}}_{{copies_pages_list.0.page_no}}").click();
                setTimeout(() => {
                    document.getElementById("copy_{{copies_pages_list.0.copy_no}}_{{copies_pages_list.0.page_no}}").click()
                }, 350);
            {% endif %}

            SidebarCollapse();

            $('#reviewGroup_div').on('keydown', function (event) {
                switch (event.key) {
                    case "ArrowLeft":
                    case "ArrowUp":
                        previous_bt = document.getElementById('previous_page');
                        if (previous_bt != null) {
                            previous_bt.click();
                        }
                        break;
                    case "ArrowRight":
                    case "ArrowDown":
                        next_bt = document.getElementById('next_page');
                        if (next_bt != null) {
                            next_bt.click();
                        }
                        break;
                }
            }).focus();

        });

        document.getElementById("expandCollapseGroupListBt").addEventListener("click", function (event) {
            var expandIcon = $("#expand-group-list-icon");
            var collapseIcon = $("#collapse-group-list-icon");
            if (collapseIcon.hasClass('fa-angle-double-left')) {
                collapseIcon.removeClass('fa-angle-double-left');
                expandIcon.addClass("fa-solid fa-table-list")
                expandIcon.show();
                collapseIcon.hide();
            } else {
                expandIcon.removeClass('fa-solid fa-table-list');
                collapseIcon.addClass("fa-angle-double-left")
                collapseIcon.show();
                expandIcon.hide();
            }

        });

        {% if pages_group.use_grading_scheme %}
        function disableOtherSchemesExcept(activeId) {
            document.querySelectorAll('#review-scheme-pills .nav-link').forEach(a => {
                const id = a.id.replace('review-scheme-link-', '');
                if (id !== String(activeId)) {
                    a.classList.add('disabled');
                    a.setAttribute('aria-disabled', 'true');
                    a.setAttribute('tabindex', '-1');

                    // Add tooltip attrs
                    const usedLink = document.getElementById('review-scheme-link-' + activeId);
                    const usedName = usedLink ? usedLink.textContent.trim() : `#${activeId}`;

                    const msg = "This scheme can't be used because "+usedName+" is already used !";
                    a.parentNode.setAttribute('data-toggle', 'tooltip');
                    a.parentNode.setAttribute('data-placement', 'top');
                    a.parentNode.setAttribute('title', msg);

                    // Initialize (or update) Bootstrap tooltip
                    let tip = bootstrap.Tooltip.getInstance(a);
                    if (tip) {
                        tip.setContent({'.tooltip-inner': msg});
                    } else {
                        tip = new bootstrap.Tooltip(a);
                    }
                }
            });
        }

        function enableAllSchemes() {
            document.querySelectorAll('#review-scheme-pills .nav-link').forEach(a => {
                a.classList.remove('disabled');
                a.removeAttribute('aria-disabled');
                a.removeAttribute('tabindex');

                // Dispose tooltip cleanly
                const tip = bootstrap.Tooltip.getInstance(a);
                if (tip) tip.dispose();
                a.parentNode.removeAttribute('data-toggle');
                a.parentNode.removeAttribute('data-placement');
                a.parentNode.removeAttribute('title');
            });
        }

        function updatePagesGroupCheckBox(item_id, checked, adjustment) {
            adjust_value = adjustment;
            //check if adjustment
            if (adjustment) {
                checkbox_id = item_id.replace('adj', 'check');
                checked = document.getElementById(checkbox_id).checked;
            } else {
                adjust_id = item_id.replace('check', 'adj');
                adjust_el = document.getElementById(adjust_id);
                if (adjust_el) {
                    adjust_value = adjust_el.value;
                }
            }

            $.ajax({
                url: "{% url 'update_pages_group_check_box' exam_selected.id %}",
                type: "POST",
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                    'item_id': item_id,
                    'copy_nr': currSourceIdSplit[1],
                    'checked': checked,
                    'adjustment': adjust_value,
                    'pages_group_id': {{ pages_group.id }},
                    'grading_scheme_id': current_grading_scheme_id
                },
                success: (response) => {
                    if (response !== '') {
                        resp_data = JSON.parse(response);
                        corr_box_to_check = resp_data[0]
                        points = resp_data[1]
                        max_points = resp_data[2]

                        if (points !== '') {
                            maxPoints = Number(max_points);
                            points_content = Number(points).toFixed(2) + " / " + maxPoints.toFixed(2);
                            document.getElementById('gsc-points-'+current_grading_scheme_id).textContent = points_content;

                            if (Number(points) > 0){
                                disableOtherSchemesExcept(current_grading_scheme_id);
                            } else {
                                enableAllSchemes();
                            }
                        }

                        const corr_boxes_polygons = document.querySelectorAll('#corrector_boxes_svg polygon');
                        const corr_box_to_click = corr_boxes_polygons[parseInt(corr_box_to_check)];
                        const pos = corr_box_to_click.getAttribute('data-bounds').split(',').map(Number);
                        createMarker4CorrBox(pos[0], pos[1], pos[2], pos[3]);
                    }
                }
            });
        }

        function sendScheme(el, evt) {
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }

            el.classList.add('active');
            el.setAttribute('aria-selected','true');
            const clickedId = el.id.replace('review-scheme-link-', '');

            var current = el.getAttribute('data-hx-get') || '';
            var copyNo = currSourceIdSplit[1];
            if (copyNo == null) return false;

            var updated = current.replace(/\/[^/?#]+(?=[?#]|$)/, '/' + encodeURIComponent(copyNo));
            el.setAttribute('data-hx-get', updated);

            // One-time listener for THIS swap; will fire after the panel HTML is inserted
            const onAfterSwap = (e) => {
                // Only react to the scheme panel swap
                if (!e.detail || !e.detail.target || e.detail.target.id !== 'review-scheme-panel') return;

                const usedId = e.detail.xhr && e.detail.xhr.getResponseHeader('X-Used-Grading-Scheme-Id');
                const activeId = usedId || el.id.replace('review-scheme-link-', '');
                current_grading_scheme_id = activeId;

                // toggle active state to the scheme the SERVER actually used
                document.querySelectorAll('#review-scheme-pills .nav-link').forEach(a => {
                  a.classList.remove('active');
                  a.setAttribute('aria-selected', 'false');
                });

                // disable other scheme if this one is used in checkboxes
                const points = e.detail.xhr.getResponseHeader('X-Points');
                if( points !== '' && points > 0) {
                    disableOtherSchemesExcept(usedId);
                }else{
                    enableAllSchemes();
                }

                const toActivate = document.getElementById('review-scheme-link-' + activeId);
                if (toActivate) {
                  toActivate.classList.add('active');
                  toActivate.setAttribute('aria-selected', 'true');
                }

                // optional: load the checkbox panel explicitly (if you’re not using hx-trigger="load once")
                const gsId   = activeId;                       // use the resolved scheme id
                const examId = el.getAttribute('data-exam-id');
                const chk    = document.getElementById('chk-panel-' + gsId);
                if (chk && examId) {
                  const chkUrl = `/review_grading_scheme_checkboxes/${examId}/${gsId}/${encodeURIComponent(copyNo)}`;
                  chk.setAttribute('hx-get', chkUrl);
                  htmx.ajax('GET', chkUrl, { target: chk, swap: 'innerHTML', source: chk });
                }

                // remove this one-time handler
                document.body.removeEventListener('htmx:afterSwap', onAfterSwap);
            };
            document.body.addEventListener('htmx:afterSwap', onAfterSwap);

            // Fire the request (no “active” toggle yet; we’ll do it in onAfterSwap)
            htmx.ajax('GET', updated, {
                target: '#review-scheme-panel',
                swap: 'innerHTML',
                source: el
            });

            return false;
        }

        /* Manage review grading scheme splittable divs */
        (function () {
            const MIN_TOP = 80;   // px
            const MIN_BOT = 120;  // px

            function initSplitters(root = document) {
                const splits = root.querySelectorAll('.review-grading-scheme-split-vert');
                splits.forEach(split => {
                    const handle = split.querySelector('.divider');
                    if (!handle) return;

                    // Avoid duplicate bindings if HTMX re-renders
                    if (handle.__splitBound) return;
                    handle.__splitBound = true;

                    let startY, startTop, maxTop;

                    const getY = (e) => ('touches' in e ? e.touches[0].clientY : e.clientY);
                    const px = (n) => `${n}px`;

                    function onDown(e) {
                        const rect = split.getBoundingClientRect();
                        startY = getY(e);

                        const cs = getComputedStyle(split);
                        const varTop = parseFloat(cs.getPropertyValue('--top')) || NaN;
                        const row0 = parseFloat(cs.gridTemplateRows.split(' ')[0]);
                        startTop = isNaN(varTop) ? row0 : varTop;

                        maxTop = rect.height - MIN_BOT - handle.offsetHeight;

                        document.body.classList.add('dragging');

                        window.addEventListener('mousemove', onMove, {passive: false});
                        window.addEventListener('touchmove', onMove, {passive: false});
                        window.addEventListener('mouseup', onUp, {once: true});
                        window.addEventListener('touchend', onUp, {once: true});

                        e.preventDefault();
                    }

                    function onMove(e) {
                        const dy = getY(e) - startY;
                        let newTop = Math.min(Math.max(startTop + dy, MIN_TOP), maxTop);
                        split.style.setProperty('--top', px(newTop));
                        e.preventDefault();
                    }

                    function onUp() {
                        document.body.classList.remove('dragging');
                        window.removeEventListener('mousemove', onMove);
                        window.removeEventListener('touchmove', onMove);
                    }

                    handle.addEventListener('mousedown', onDown);
                    handle.addEventListener('touchstart', onDown, {passive: false});
                });
            }

            // Initial
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => initSplitters());
            } else {
                initSplitters();
            }

            // Re-init when HTMX swaps your panel
            document.body.addEventListener('htmx:afterSwap', (evt) => {
                if (evt.target && evt.target.id === 'review-scheme-panel') {
                    // Rebind inside the swapped content
                    initSplitters(evt.target);
                }
            });
        })();
        {% endif %}
    </script>
    {% else %}
    <div class="alert alert-warning" role="alert" style="margin-top:20px;text-align:center;">No scans uploaded !</div>
    {% endif %}
{% endif %}
    {% endblock %}