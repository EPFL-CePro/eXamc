{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block extra_head %}

<script type="text/javascript"  src="https://cdnjs.cloudflare.com/ajax/libs/jquery.textcomplete/1.8.0/jquery.textcomplete.js"></script>
<script type="text/javascript" src="{% static 'js/jquery-comments.js' %}"></script>
<script type="text/javascript" src="https://unpkg.com/markerjs2/markerjs2.js"></script>
<script src="https://cdn.tiny.cloud/1/kr9ouegwtqai2kg8nadg9x584jbqawgxkc832sts20ujsde9/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<link rel="stylesheet" type="text/css" href="{% static 'css/jquery-comments.css' %}">

{% endblock %}

{% block title %}Review {{ pages_group }}{% endblock %}
{% block scripts %}
  
    
let sourceImage, markedImage, targetRoot, maState, currSourceElementId, currSourceIdSplit, markerArea;
let group_pathes = JSON.parse('{{json_group_scans_pathes|safe }}');

window.addEventListener('resize', function(event) {
    
    location.reload();    
}, true);  
    
// save references to the original image and its parent div (positioning root)
function setSourceImage(source) {
    sourceImage = source;
    targetRoot = source.parentElement;
}

function createPagination(pages, page) {
    
    
    
    let str = ''//'<ul class="list-group list-group-horizontal">';

    setSourceScan(group_pathes[page-1]["path"], "");

    // Show the Previous button only if you are on a page other than the first
    if (page > 1) {
        str += '<a class="list-group-item list-group-item-action" onclick="createPagination('+pages+', '+(page-1)+')">Previous</a>';
    }

    // Show the very first page followed by a "..." at the beginning of the
    // pagination section (after the Previous button)
    if (page > 1) {
        str += '<a class="list-group-item list-group-item-action" onclick="createPagination('+pages+', 1)">1</a>';
        if (page > 2) {
            str += '<a class="list-group-item list-group-item-action" onclick="createPagination('+pages+','+(page-2)+')">...</a>';
        }
    }
    // Determine how many pages to show after the current page index
    if (page === 1) {
        <!-- pageCutHigh += 1; -->
    } else if (page === 2) {
        <!-- pageCutHigh += 0; -->
    }
    // Determine how many pages to show before the current page index
    if (page === pages) {
        <!-- pageCutLow -= 1; -->
    } else if (page === pages-1) {
        <!-- pageCutLow -= 0; -->
    }
    // active page
    str += '<a class="list-group-item list-group-item-action active" onclick="createPagination('+pages+', '+page+')">'+page +'</a>';

    // Show the very last page preceded by a "..." at the end of the pagination
    // section (before the Next button)
    if (page < pages-1) {
        if (page < pages-2) {
            str += '<a class="list-group-item list-group-item-action" onclick="createPagination('+pages+','+(page+2)+')">...</a>';
        }
        str += '<a class="list-group-item list-group-item-action" onclick="createPagination('+pages+','+pages+')">'+pages+'</a>';
    }
    // Show the Next button only if you are on a page other than the last
    if (page < pages) {
        str += '<a class="list-group-item list-group-item-action" onclick="createPagination('+pages+','+(page+1)+')">Next</a>';
    }

    // Return the pagination string to be outputted in the pug templates
    document.getElementById("pagination").innerHTML = str;
    setMarkerArea();
}

function setSourceScan(scan_path){
    old_source = document.getElementById("source_img").src;
    sourceImage = document.getElementById("source_img");
    sourceImage.src = scan_path;
    targetRoot = sourceImage.parentElement;
    old_marked = document.getElementById("marked_img").src;
    markedImage = document.getElementById("marked_img");
    markedImage.src = scan_path;

    // change current and last source element background color
    currSourceIdSplit = scan_path.split('/').pop().split('.').slice(-2)[0].split('_');
    currSourceElementId =
    currSourceIdSplit[0]+"_"+currSourceIdSplit[1]+"_"+parseFloat(currSourceIdSplit[2].replace("x","."));
    if (old_source){
        lastSourceIdSplit = old_source.split('/').pop().split('.').slice(-2)[0].split('_');
        lastSourceElementId =
        lastSourceIdSplit[0]+"_"+lastSourceIdSplit[1]+"_"+parseFloat(lastSourceIdSplit[2].replace("x","."));
        document.getElementById(lastSourceElementId).style.backgroundColor = "";
    }
    document.getElementById(currSourceElementId).style.backgroundColor = "yellow";
}

function setMarkerArea(target) {
    markerArea = new markerjs2.MarkerArea(sourceImage);
    markerArea.uiStyleSettings.redoButtonVisible = true;
    markerArea.uiStyleSettings.notesButtonVisible = true;
    markerArea.uiStyleSettings.zoomButtonVisible = true;
    markerArea.uiStyleSettings.zoomOutButtonVisible = true;
    markerArea.uiStyleSettings.clearButtonVisible = true;
    markerArea.uiStyleSettings.resultButtonBlockVisible = false;
    markerArea.settings.newFreehandMarkerOnPointerUp = true;

    // since the container div is set to position: relative it is now our positioning root
    // end we have to let marker.js know that
    markerArea.targetRoot = targetRoot;

    markerArea.addEventListener("render", (event) => {
        markedImage.src = event.dataUrl;
        // save the state of MarkerArea
        //maState = event.state;
        //updateMarkers(markerArea,"{{ exam.pk }}","{{ pages_group.pk }}");
    });

    markerArea.addEventListener("close", (event) => {
        setMarkerArea();
    });

    //get Markers (state) if exist
    imgsrc_split = sourceImage.src.split('/').pop().split('.').slice(-2)[0].split('_');
    copy_no = currSourceIdSplit[1];
    page_no = currSourceIdSplit[2];
    maState = getMarkersAndComments("{{ exam.pk }}",copy_no,page_no,sourceImage.getAttribute("src"));

    markerArea.show();
    // if previous state is present - restore it
    if (maState) {
        markerArea.restoreState(maState);
    }

    markerArea.addEventListener("markerdeselect", (event) => {
        markerDeselect();
    });

}
    
function markerDeselect(){
    svgData = new XMLSerializer().serializeToString(markerArea.markerImage);
    svgDataBase64 = btoa(unescape(encodeURIComponent(svgData)));
    svgDataUrl = `data:image/svg+xml;charset=utf-8;base64,${svgDataBase64}`;

    addMarkersImageProcess(svgDataUrl).then(img => {
        var canvas = document.createElement('canvas')
    
        canvas.setAttribute('width', markerArea.target.naturalWidth)
        canvas.setAttribute('height', markerArea.target.naturalHeight)

        var context = canvas.getContext('2d')
        context.drawImage(markerArea.target, 0, 0, markerArea.target.naturalWidth, markerArea.target.naturalHeight)
        context.drawImage(img, 0, 0, markerArea.target.naturalWidth, markerArea.target.naturalHeight)
        var dataUrl = canvas.toDataURL('image/png')
        markedImage.src = dataUrl;
        updateMarkers(markerArea,"{{ exam.pk }}","{{ pages_group.pk }}"); 
    });
}
    
function addMarkersImageProcess(src){
  return new Promise((resolve, reject) => {
    let img = new Image()
    img.onload = () => resolve(img)
    img.onerror = reject
    img.src = src
  })
}  
    
function getMarkersAndComments(pk,copy_no,page_no,filename){
    var markers;
    $.ajax({
        url: "{% url 'get_markers_and_comments' %}",
        async : false,
        type: "POST",
        data : {
            'csrfmiddlewaretoken' : "{{ csrf_token }}",
            'exam_pk' : pk,
            'copy_no' : copy_no,
            'page_no' : ""+page_no,
            'filename' : filename,
            'group_id' : {{ pages_group.id }}
        },
        success: (data) => {
            markers="None";
            if(data!="None"){
                data_full = JSON.parse(data);
                state=JSON.parse(data_full.markers);
                comments=data_full.comments;
                initComments(comments);
            }
        },
        error: (error) => {
            console.log(error);
        }
    });
    return state;
}

function initCopyPagesTableOnClickRowEvent(refresh){

    $("#table-copies-pages").on('click', 'tr', function () {
        createPagination({{ scans_pathes_list|length }}, parseFloat(this.cells[0].innerText));
    });

    if(!refresh){
        var table = $("#table-copies-pages").DataTable( {
            scrollY: '85vh',
            "dom": 'rtip',
            "lengthChange": false,
            "paging": false
        } );
    }
}

async function updateMarkers(markerArea, exam_pk, pages_group_pk){
    imgsrc_split = sourceImage.src.split('/').pop().split('.').slice(-2)[0].split('_');
    copy_no = currSourceIdSplit[1];
    page_no = currSourceIdSplit[2];

    saveMarkers(exam_pk, pages_group_pk,copy_no,page_no,JSON.stringify(markerArea.getState()),markedImage.src,"None",sourceImage.getAttribute("src"));

    initCopyPagesTableOnClickRowEvent(true);
    document.getElementById(currSourceElementId).style.backgroundColor = "yellow";
    marked_info_element = document.getElementById(currSourceElementId+"_marked")
    marked_info_element.innerHTML = ""
    if(markerArea.markers.length > 0){
        marked_info_element.innerHTML = '<i class="fas fa-circle" style="font-size:18px;color:green;padding-left:25px;">'
    }
}

function saveMarkers(pk,group_pk,copy_no,page_no,markers,marked_img_dataUrl,comment,filename){
    $.ajax({
        url : "{% url 'save_markers' %}",
        async : false,
        type : "POST",
        data : {
            'csrfmiddlewaretoken' : "{{ csrf_token }}",
            'exam_pk' : pk,
            'reviewGroup_pk' : group_pk,
            'copy_no' : copy_no,
            'page_no' : ""+page_no,
            'markers' : markers,
            'marked_img_dataUrl' : marked_img_dataUrl,
            'comment' : comment,
            'filename' : filename
        },
        beforeSend : function(){
            $('#loadingModal').modal('show');
        },
        complete: function () {
            $('#loadingModal').modal('hide');
        }
    });
}

function saveComment(data){
    copy_no = currSourceIdSplit[1];

    // Convert pings to human readable format
    $(Object.keys(data.pings)).each(function(index, userId) {
        var fullname = data.pings[userId];
        var pingText = '@' + fullname;
        data.content = data.content.replace(new RegExp('@' + userId, 'g'), pingText);
    });

    $.ajax({
        url : "{% url 'save_comment' %}",
        async : false,
        type : "POST",
        data : {
            'csrfmiddlewaretoken' : "{{ csrf_token }}",
            'comment' : JSON.stringify(data),
            'group_id' : {{ pages_group.id }},
            'copy_no' : copy_no
        }
    });

    return data;
}

function initComments(commentsArray){
    $('#comments-container').comments({
        profilePictureURL: 'fa fa-user-circle fa-sm',
        currentUserId: 1,
        roundProfilePictures: true,
        textareaRows: 1,
        enableAttachments: false,
        enableHashtags: false,
        enableUpvoting: false,
        enableEditing: true,
        enableDeleting: true,
        scrollContainer: $(window),
        searchUsers: function(term, success, error) {
            setTimeout(function() {
                success(usersArray.filter(function(user) {
                    var containsSearchTerm = user.fullname.toLowerCase().indexOf(term.toLowerCase()) != -1;
                    var isNotSelf = user.id != {{ user.id }};
                    return containsSearchTerm && isNotSelf;
                }));
            }, 500);
        },
        getComments: function(success, error) {
            setTimeout(function() {
                success(commentsArray);
            }, 500);
        },
        postComment: function(data, success, error) {
            setTimeout(function() {
                success(saveComment(data));
            }, 500);
        },
        putComment: function(data, success, error) {
            setTimeout(function() {
                success(saveComment(data));
            }, 500);
        },
    });
};


$(window).on("load",function(){
    initCopyPagesTableOnClickRowEvent(false);
    {% if currpage > 0 %}
    createPagination({{ scans_pathes_list|length }}, {{ currpage }});
    {% else %}
    createPagination({{ scans_pathes_list|length }}, 1);
    {% endif %}

    //hide top and side bars
    var wrapper = document.getElementById("wrapper")
    var sideb = document.getElementById("sidebar-wrapper");
    wrapper.style.paddingLeft = "20px";
    sideb.style.display = "none";
});
 
{% endblock %}

{% block content %}
{%  if scans_pathes_list %}
<div style="width: 66%;">
    <div style="width: 50%; height: 50px; float: left; "> 
        <h3>Review {{ pages_group.group_name }}</h3>
    </div>
    <div style="margin-left: 50%; height: 50px; text-align:right;"> 
        <a style="margin-left:150px;" href="{% url 'reviewView' exam.pk %}" class="btn btn-outline-dark btn-sm">Back to Summary</a>
    </div>
</div>
<div class="d-flex" style="height:93vh;">
    <div id="pages_group_list" style="background-color:#f1f1f1;">
        <table class="table table-striped table-sm" id="table-copies-pages">
            <thead>
            <tr>
                <th>id</th>
                <th>Copy</th>
                <th>Page</th>
                <th>Annotated</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for page in scans_pathes_list %}
            <tr id="copy_{{page.copy_no}}_{{page.page_no}}">
                <td>{{ forloop.counter }}</td>
                <td>{{ page.copy_no }}</td>
                <td>{{ page.page_no }}</td>
                <td id="copy_{{page.copy_no}}_{{page.page_no}}_marked" >{% if page.marked %}<i class="fas fa-circle"
                                           style="font-size:18px;color:green;padding-left:25px;">{% endif %}</i></td>
                <td>
                    {% if page.comment %}
                    <i class="fas fa-comments fa-lg"></i>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="list-group" style="height:100%;margin-left:5px" >
        <div id="pagination" class="list-group list-group-horizontal"></div>
        <div id="markerjs_div" style="height:98%;aspect-ratio:1/1.41;overflow-y: auto;border:1px solid lightgrey;">
            <div class="col-xs-6" style="position: relative; display: flex; flex-direction: column;">
                <img id="source_img" style=""/>
                <img id="marked_img" style="max-width:100%;position: absolute;"/>
            </div>
        </div>
    </div>
    <div style="background-color:#f1f1f1;padding:20px;">
        <div class="row">
            <div style="float:right;">
                <a title="Discussion" id="expandCollapseCommentsBt" type="button" data-bs-toggle="collapse" style="float:right;"  data-bs-target="#comments-div" aria-expanded="false" aria-controls="comments-div">
                    <i id="comment-icon" class="fas fa-comments fa-lg"></i>
                    <i id="collapse-d-icon" class="fa fa-2x mr-3"></i>
                </a>
                <div id="comments-div" class="collapse collapse-horizontal" style="margin-left:5px;background-color:#f1f1f1;width:25%;min-width:600px;">
                    <div>
                        <p class="table th">
                            <i class="fas fa-comments fa-lg"></i>
                            DISCUSSION
                        </p>
                    </div>
                    <hr>
                    <div id="comments-container" style="padding:5px;"></div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div style="float:right">
                <a title="Grading help" id="expandCollapseGradingHelpBt" type="button" data-bs-toggle="collapse" style="float:right;" data-bs-target="#grading-help-div" aria-expanded="false" aria-controls="grading-help-div">
                    <i id="grading-help-icon" class="fas fa-question-circle fa-lg"></i>
                    <i id="collapse-gh-icon" class="fa fa-2x mr-3"></i>
                </a>
                <div id="grading-help-div" class="collapse collapse-horizontal" style="margin-left:5px;background-color:#f1f1f1;width:25%;min-width:600px;">
                    <div>
                        <p class="table th">
                            <i class="fas fa-question-circle fa-lg"></i>
                            GRADING HELP
                        </p>
                    </div>
                    <hr>
                    <div id="grading-help-container" style="padding:5px;"><textarea id="grading-help_textarea"></textarea></div>
                </div>
            </div>

        </div>
    </div>

</div>


<script>
tinymce.init({
    selector: 'textarea#grading-help_textarea',
    skin: 'bootstrap',
    plugins: '',
    toolbar: '',
    menubar: false,
    readonly: 1,
    height: "750",
});



document.getElementById("expandCollapseCommentsBt").addEventListener("click", function(event) {
    var commentIcon = $( "#comment-icon" );
    var collapseIcon = $( "#collapse-d-icon" );
    if(collapseIcon.hasClass('fa-angle-double-left')){
        collapseIcon.removeClass('fa-angle-double-left');
        commentIcon.show();
    }else{
        collapseIcon.addClass('fa-angle-double-left');
        commentIcon.hide();
    }

});

document.getElementById("expandCollapseGradingHelpBt").addEventListener("click", function(event) {
    var gradingHelpIcon = $( "#grading-help-icon" );
    var collapseIcon = $( "#collapse-gh-icon" );
    if(collapseIcon.hasClass('fa-angle-double-left')){
        collapseIcon.removeClass('fa-angle-double-left');
        gradingHelpIcon.show();
    }else{
        collapseIcon.addClass('fa-angle-double-left');
        gradingHelpIcon.hide();


        $.ajax({
            url: "{% url 'get_pages_group_grading_help' %}",
            async : false,
            type: "POST",
            data : {
                'csrfmiddlewaretoken' : "{{ csrf_token }}",
                'pk' : {{ pages_group.id }},
            },
            success: (data) => {
                tinymce.get("grading-help_textarea").setContent(data);
                tinymce.activeEditor.mode.set("readonly");
            },
            error: (error) => {
                console.log(error);
            }
        });



    }

});

    // add event listener focusout to markerjs_div to update markers
    document.getElementById("markerjs_div").addEventListener('focusout', e => {
        alert('out');
    });

</script>
{% else %}
<div class="alert alert-warning" role="alert" style="margin-top:20px;text-align:center;">There is no scans uploaded !</div>
{% endif %}
{% endblock %}