{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block extra_head %}
<script src="https://unpkg.com/markerjs-live/markerjs-live.js"></script>
<script src="https://unpkg.com/markerjs2/markerjs2.js"></script>

{% endblock %}

{% block title %}Review {{ pages_group.name }}{% endblock %}

{% block scripts %}
//------------------------------TEST


var test = {
  width: 600,
  height: 583,
  markers: [
    {
      fillColor: "transparent",
      strokeColor: "#EF4444",
      strokeWidth: 3,
      strokeDasharray: "",
      opacity: 1,
      left: 162,
      top: 71,
      width: 156,
      height: 194,
      rotationAngle: 0,
      visualTransformMatrix: { a: 1, b: 0, c: 0, d: 1, e: 0, f: 0 },
      containerTransformMatrix: { a: 1, b: 0, c: 0, d: 1, e: 0, f: 0 },
      typeName: "FrameMarker",
      state: "select"
    }
  ]
};

{% for key, value in scans_pathes_list.items %}
let sourceImage{{ key }}, targetRoot{{ key }}, maState{{ key }};

// save references to the original image and its parent div (positioning root)
function setSourceImage{{ key }}(source) {
  sourceImage{{ key }} = source;
  targetRoot{{ key }} = source.parentElement;
}


function showMarkerArea{{ key }}(target) {
  const markerArea{{ key }} = new markerjs2.MarkerArea(sourceImage{{ key }});
  // since the container div is set to position: relative it is now our positioning root
  // end we have to let marker.js know that
  markerArea{{ key }}.targetRoot = targetRoot{{ key }};
  markerArea{{ key }}.uiStyleSettings.redoButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.notesButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.zoomButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.zoomOutButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.clearButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.resultButtonBlockVisible = false
  markerArea{{ key }}.addEventListener("render", (event) => {
    target.src = event.dataUrl;
    // save the state of MarkerArea
    maState{{ key }} = event.state;
  });
  markerArea{{ key }}.show();
  // if previous state is present - restore it
  if (maState{{ key }}) {
    markerArea{{ key }}.restoreState(test);
  }
}
{% endfor %}
//------------------------------TEST



//let sourceImage, target, targetRoot, maState, markerArea;
let groups_paths = JSON.parse('{{json_groups_scans_pathes|safe }}');

{% for key, value in scans_pathes_list.items %}
function createPagination{{ key }}(pages, page) {
    let str = ''//'<ul class="list-group list-group-horizontal">';

    setSourceScan{{ key }}(groups_paths["{{ key }}"][page-1]["path"], "{{ key }}");

    // Show the Previous button only if you are on a page other than the first
    if (page > 1) {
      str += '<a class="list-group-item list-group-item-action" onclick="createPagination{{ key }}('+pages+', '+(page-1)+')">Previous</a>';
    }

    // Show the very first page followed by a "..." at the beginning of the
    // pagination section (after the Previous button)
    if (page > 1) {
      str += '<a class="list-group-item list-group-item-action" onclick="createPagination{{ key }}('+pages+', 1)">1</a>';
      if (page > 2) {
        str += '<a class="list-group-item list-group-item-action" onclick="createPagination{{ key }}('+pages+','+(page-2)+')">...</a>';
      }
    }
    // Determine how many pages to show after the current page index
    if (page === 1) {
      <!-- pageCutHigh += 1; -->
    } else if (page === 2) {
      <!-- pageCutHigh += 0; -->
    }
    // Determine how many pages to show before the current page index
    if (page === pages) {
      <!-- pageCutLow -= 1; -->
    } else if (page === pages-1) {
      <!-- pageCutLow -= 0; -->
    }
    // active page
    str += '<a class="list-group-item list-group-item-action active"onclick="createPagination{{ key }}('+pages+', '+page+')">'+ page +'</a>';

    // Show the very last page preceded by a "..." at the end of the pagination
    // section (before the Next button)
    if (page < pages-1) {
      if (page < pages-2) {
        str += '<a class="list-group-item list-group-item-action" onclick="createPagination{{ key }}('+pages+','+(page+2)+')">...</a>';
      }
      str += '<a class="list-group-item list-group-item-action" onclick="createPagination{{ key }}('+pages+','+pages+')">'+pages+'</a>';
    }
    // Show the Next button only if you are on a page other than the last
    if (page < pages) {
      str += '<a class="list-group-item list-group-item-action" onclick="createPagination{{ key }}('+pages+','+(page+1)+')">Next</a>';
    }

    // Return the pagination string to be outputted in the pug templates
    document.getElementById("pagination-{{ key }}").innerHTML = str;
    setMarkerArea{{ key }}();
    return str;
  }

function setSourceScan{{ key }}(scan_path){
  old_source = document.getElementById("source_img-{{ key }}").src;
  document.getElementById("source_img-{{ key }}").src = scan_path;
  document.getElementById("marked_img-{{ key }}").src = scan_path;

  // change current and last source element background color
  currSourceIdSplit{{ key }} = scan_path.split('/').pop().split('.').slice(-2)[0].split('_');
  currSourceElementId{{ key }} = currSourceIdSplit{{ key }}[0]+"_"+parseInt(currSourceIdSplit{{ key }}[1])+"_"+parseInt(currSourceIdSplit{{ key }}[2]);
  if (old_source){
    lastSourceIdSplit = old_source.split('/').pop().split('.').slice(-2)[0].split('_');
    lastSourceElementId = lastSourceIdSplit[0]+"_"+parseInt(lastSourceIdSplit[1])+"_"+parseInt(lastSourceIdSplit[2]);
    document.getElementById(lastSourceElementId).style.backgroundColor = "";
  }
  document.getElementById(currSourceElementId{{ key }}).style.backgroundColor = "yellow";
}

function setMarkerArea{{ key }}(){

  sourceImage{{ key }} = document.getElementById("source_img-{{ key }}");
  target{{ key }} = document.getElementById("marked_img-{{ key }}" );
  targetRoot{{ key }} = sourceImage{{ key }}.parentElement;

  //MarkerArea settings
  markerArea{{ key }} = new markerjs2.MarkerArea(sourceImage{{ key }});
  markerArea{{ key }}.uiStyleSettings.redoButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.notesButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.zoomButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.zoomOutButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.clearButtonVisible = true;
  markerArea{{ key }}.uiStyleSettings.resultButtonBlockVisible = false

  // set position to parent div to align
  markerArea{{ key }}.targetRoot = targetRoot{{ key }};

  //
  markerArea{{ key }}.addEventListener("markercreate", (event) => {
    imgsrc_split = sourceImage{{ key }}.src.split('/').pop().split('.').slice(-2)[0].split('_');
    copy_no = currSourceIdSplit{{ key }}[1];
    page_no = currSourceIdSplit{{ key }}[2];

    saveMarkers("{{ exam.pk }}",copy_no,page_no,JSON.stringify(markerArea{{ key }}.getState()),"no comment",sourceImage{{ key }}.getAttribute("src"));
  });
  markerArea{{ key }}.addEventListener("markerdelete", (event) => {
    alert('delete');
  });
  markerArea{{ key }}.addEventListener("markerchange", (event) => {
    alert('change');
  });

  //get Markers (state) if exist
  imgsrc_split = sourceImage{{ key }}.src.split('/').pop().split('.').slice(-2)[0].split('_');
  copy_no = currSourceIdSplit{{ key }}[1];
  page_no = currSourceIdSplit{{ key }}[2];

  state = getMarkers("{{ exam.pk }}",copy_no,page_no,sourceImage{{ key }}.getAttribute("src"));
  markerArea{{ key }}.show();
  if(state!="None"){
    markerArea{{ key }}.restoreState(test);
  }

}
{% endfor %}

function initCopyPagesTableOnClickRowEvent(){

  {% for key, value in scans_pathes_list.items %}

    $("#table-copies-pages-{{ key|cut:' '}}").on('click', 'tr', function () {
      createPagination{{ key }}({{ value|length }}, parseInt(this.cells[0].innerText));
    });

    var table = $("#table-copies-pages-{{ key|cut:' '}}").DataTable( {
        scrollY:    '900px',
        "dom": 'rtip',
        "lengthChange": false,
        "paging": false
    } );

  {% endfor %}
}

function saveMarkers(pk,copy_no,page_no,markers,comment,filename){
    $.ajax({
      url : "{% url 'save_markers' %}",
      type : "POST",
      data : {
        'csrfmiddlewaretoken' : "{{  csrf_token  }}",
        'exam_pk' : pk,
        'copy_no' : copy_no,
        'page_no' : ""+page_no,
        'markers' : markers,
        'comment' : comment,
        'filename' : filename
      },
      beforeSend : function(){
        $('#loadingModal').modal('show');
      },
      complete: function () {
        $('#loadingModal').modal('hide');
      }
    });
}

function getMarkers(pk,copy_no,page_no,filename){
  var markers;
  $.ajax({
    url: "{% url 'get_markers' %}",
    async : false,
    type: "POST",
    data : {
      'csrfmiddlewaretoken' : "{{  csrf_token  }}",
      'exam_pk' : pk,
      'copy_no' : copy_no,
      'page_no' : ""+page_no,
      'filename' : filename
    },
    success: (data) => {
      markers="None";
      if(data!="None"){
        markers=JSON.parse(data);
      }
    },
    error: (error) => {
      console.log(error);
    }
  });
  return markers;
}

$(window).on("load",function(){
  //showMarkerArea();
  //initPagination();
  initCopyPagesTableOnClickRowEvent();
  //setMarkerArea("Question1");

  $('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
    var target = $(e.target).attr("href") // activated tab
    if(target!="#pills-review-summary"){
      splitTarget = target.split('-');
      group_name = splitTarget.pop();
      group_len = splitTarget.pop();
      switch (target) {
        {% for key, value in scans_pathes_list.items %}
          case '#pills-review-{{ value|length }}-{{ key }}' :
            //createPagination{{ key }}({{ value|length }},1);
            break;
        {% endfor %}
      }
    }
  });



//------------------------------TEST
{% for key, value in scans_pathes_list.items %}
  setSourceImage{{ key }}(document.getElementById("sourceImage{{ key }}"));

  const sampleImage{{ key }} = document.getElementById("sampleImage{{ key }}");

    showMarkerArea{{ key }}(sampleImage{{ key }});

  {% endfor %}
//------------------------------TEST


});

{% endblock %}

{% block content %}
<h3>Review</h3>
<ul class="nav nav-pills flex-column flex-sm-row border" id="review-pills-tab" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="flex-sm-fill text-sm-center nav-link active" id="review-summary-tab" data-toggle="pill" href="#pills-review-summary" role="tab" aria-controls="pills-review-summary" aria-selected="true">Review Summary</a>
  </li>
  {% for key, value in scans_pathes_list.items %}
  <li class="nav-item" role="presentation">
    <a onclick="createPagination{{ key }}({{ value|length }},1);" class="flex-sm-fill text-sm-center nav-link" id="review-{{ key }}-tab" data-toggle="pill" href="#pills-review-{{ value|length }}-{{ key }}" role="tab" aria-controls="pills-review-{{ key }}" aria-selected="false">Review {{ key }}</a>
  </li>
  {% endfor %}
</ul>

<div class="tab-content" id="review-pills-tabContent">
  <div class="tab-pane fade show active" id="pills-review-summary" role="tabpanel" aria-labelledby="pills-review-summary-tab">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Group Name</th>
          <th>Page from</th>
          <th>Page to</th>
          <th>Review</th>
        </tr>
      </thead>
      <tbody>
        {% for pages_group in exam_pages_group_list %}
        <tr>
          <td>{{ pages_group.group_name }}</td>
          <td>{{ pages_group.page_from }}</td>
          <td>{{ pages_group.page_to }}</td>
          <td><a class="btn btn-danger btn-sm" onclick="$('#review-{{ pages_group.group_name|cut:' ' }}-tab').trigger('click')">Review</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

{% for key, value in scans_pathes_list.items %}
    <div
      style="
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-top: 50px;
      "
    >
      <!-- we are putting a copy of the original image under the result image so it's always annotation-free -->
      <img
        id="sourceImage{{ key }}"
        src="../../scans/2022/2/MATH-207(c)/copy_001/copy_0001_02.jpg"
        style="max-width: 600px; max-height: 80%;"
        crossorigin="anonymous"
      />
      <img
        id="sampleImage{{ key }}"
        src="../../scans/2022/2/MATH-207(c)/copy_001/copy_0001_02.jpg"
        style="max-width: 600px; max-height: 100%; position: absolute;"
        crossorigin="anonymous"
      />
    </div>
{% endfor %}



  </div>
  {% for key, value in scans_pathes_list.items %}

  <div class="tab-pane fade" id="pills-review-{{ value|length }}-{{ key }}" role="tabpanel" aria-labelledby="pills-review-{{ key }}-tab">
    <div class="d-flex">
      <div class="list-group" style="column;max-width: 1200px;min-width:600px;">
        <div id="pagination-{{ key|cut:' ' }}" class="list-group list-group-horizontal"></div>
        <div id="markerjs_div-{{ key|cut:' ' }}" style="height:900px;overflow-y: scroll;">
          <div class="col-xs-6" style="position: relative; display: flex; flex-direction: column;">
            <img id="source_img-{{ key|cut:' ' }}" style="max-width:100%;min-width: 600px"   />
            <img id="marked_img-{{ key|cut:' ' }}" style="max-width:100%;min-width: 600px; position: absolute;"  />
          </div>
        </div>
      </div>
      <div>
        <table class="table table-striped table-sm" id="table-copies-pages-{{ key }}">
          <thead>
            <tr>
              <th>id</th>
              <th>Copy</th>
              <th>Page</th>
              <th>Annotated</th>
            </tr>
          </thead>
          <tbody>
            {% for page in value %}
            <tr id="copy_{{page.copy_no}}_{{page.page_no}}">
              <td>{{ forloop.counter }}</td>
              <td>{{ page.copy_no }}</td>
              <td>{{ page.page_no }}</td>
              <td>to do</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
</div>

  {% endfor %}

{% endblock %}
