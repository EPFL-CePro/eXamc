
{% load static %}
{%  load custom_tags %}

<div style="padding:20px;width:800px;">
    <h6>Data capture after examination</h6>
    <div class="mb-3" style="text-align: center;padding:10px;">
        <button type="button" data-toggle="modal" data-target="#confirmAutomaticDataCaptureModal" class="btn btn-dark btn-sm" style="margin:0 50% 0 0;">
            <img src="{% static 'img/amc_icons/amc-auto-capture.svg' %}" width="16px" height="16px" style="margin-right:10px;"/>
            Automatic
        </button>
        <a href="{% url 'amc_data_capture_manual' exam.pk %}" class="btn btn-dark btn-sm">
            <img src="{% static 'img/amc_icons/amc-manual-capture.svg' %}" width="16px" height="16px" style="margin-right:10px;"/>
            Manual
        </a>
    </div>
    <hr/>
    <div class="mb-3">
        {% if data_pages %}
        {%  if missing_pages %}
        <div class="alert alert-danger" id="data-exist-msg" role="alert" style="text-align:center;">
            <a type="button" onclick="showErrorDataCaptureDialog('Missing pages')"  class="btn btn-sm">
                {{ data_capture_message }}<i class="fas fa-info-circle fa-lg" style="margin-left:25px;"></i>
            </a>
        </div>
        {% else %}
        <div class="alert alert-success" id="data-exist-msg" role="alert" style="text-align:center;">
            {{ data_capture_message }}
        </div>
        {% endif %}
        {% else %}
        <div class="alert alert-warning" id="data-exist_msg" role="alert" style="text-align:center;">No data</div>
        {% endif %}
        {%  if unrecognized_pages %}
        <div class="alert alert-dark" id="data-exist_msg" role="alert" style="text-align:center;">
            <a type="button"  onclick="showErrorDataCaptureDialog('Unrecognized pages')"  class="btn btn-sm">
                {{ unrecognized_pages|length }} scans where not recognized !<i class="fas fa-info-circle fa-lg" style="margin-left:25px;"></i>
            </a>
        </div>
        {% endif %}
        {%  if overwritten_pages %}
        <div class="alert alert-warning" id="data-exist_msg" role="alert" style="text-align:center;">
            <a type="button" onclick="showErrorDataCaptureDialog('Overwritten pages')" class="btn btn-sm">
                Overwritten pages: {{ overwritten_pages|length }}<i class="fas fa-info-circle fa-lg" style="margin-left:25px;"></i>
            </a>
        </div>
        {% endif %}
    </div>
    <hr/>
    <div class="mb-3">
        <h6>Diagnosis</h6>

        <div class="mb-3" style="width:60%;">
            <table id="table-copies-pages" class="table table-sm table-striped">
            <thead style="width:100%;">
              <tr>

                <th data-sortable="true">Copy</th>
                <th data-sortable="true">Page</th>
                <th data-sortable="true">MSE</th>
                <th data-sortable="true">Sensitivity</th>
                <th data-sortable="true">Manual</th>
                <th></th>
                <th style="display:none;width:0px;">source</th>
                <th style="display:none;width:0px;">questions</th>
              </tr>
            </thead>
            <tbody style="height:50%;">
              {% for row in data_pages %}
              <tr id="table-scan-row-{{ row.copy }}-{{ row.page }}">

                <td>{{ row.copy }}</td>
                <td> {{ row.page }}</td>
                <td>{{ row.mse }}</td>
                <td {% if row.sensitivity > 0 %}style="background-color:red;color:black;"{% endif %}>{{ row.sensitivity }}</td>
                <td>{% if row.timestamp_manual %}<i class="fas fa-star fa-sm" style="color: #0d72bf;"></i>{% endif %}</td>
                <td>
                    <button type="button" data-toggle="modal" onclick="openCopyPageZoomsDialog({{ row.copy }}, {{ row.page }});" class="btn btn-lg btn-sm">
                        <i class="far fa-eye fa-lg"></i>
                    </button>

                </td>
                <td style="display:none;">{{ row.source }}</td>
                <td style="display:none;">{{ row.questions_ids }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
</div>
<div class="modal" id="confirmAutomaticDataCaptureModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Automatic Data Capture</h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding:20px;">
        <p>From where do you want to import scans ?</p>
        <hr/>
        <div style="margin-top:50px;">
            <h6>Local file system</h6>
            <p>(.zip)</p>
            <form id="amcScansFromLocalFrm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group align-items-center">
                    <div class="col-md-10">
                        <label for="amc_scans" class="custom-file-label form-control-sm">Select scans</label>
                        <input type="file" class="custom-file-input" name="amc_scans_zip_file" id="amc_scans_zip_file" accept=".zip" required/>
                    </div>
                </div>
                <div class="form-group">
                   <div class="col-md-8">
                        <button class="btn btn-primary btn-sm" type="submit">Import</button>
                    </div>
                </div>
            </form>
        </div>
          <hr/>
        <div style="margin-top:50px;">
            <h6>eXamc Review (this app)</h6>
            <div class="form-group">
               <div class="col-md-8">
                    <button class="btn btn-primary btn-sm">Import</button>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="closeConfirmAutomaticDataCaptureModalBt" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="errorDataCaptureDialog" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Automatic Data Capture</h6>
      </div>
      <div class="modal-body" style="padding:20px;max-height:50vh;overflow-y: auto;">
        <h6 id="errorDataCaptureDialogTitle">Missing pages</h6>
        <hr/>
        <p id="errorDataCaptureDialogData"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="$('#errorDataCaptureDialog').modal('hide');">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="zoomDataCaptureDiagnosisDialog" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Zooms</h6>
      </div>
      <div class="modal-body" style="padding:20px;max-height:70vh;overflow-y: auto;">
          <div class="btn-group">
              <button type="button" class="btn btn-dark btn-sm" style="width:100px;margin-right:50px;" onclick=""><i class="fas fa-chevron-left fa-2x"></i></button>
              <h6 id="zoomDataCaptureDiagnosisDialogHeader" style="text-align: center;"></h6>
              <button type="button" class="btn btn-dark btn-sm" style="width:100px;margin-left:50px;" onclick=""><i class="fas fa-chevron-right fa-2x"></i></button>
          </div>
          <div style="padding:20px;">
            <h6>Unchecked boxes</h6>
            <table class="table">
              <tbody id="ZoomUncheckedBoxesTBody">
              </tbody>
            </table>
            <hr/>
            <h6>Checked boxes</h6>
            <table class="table">
              <tbody id="ZoomCheckedBoxesTBody">
              </tbody>
            </table>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
$('#amc_scans_zip_file').on('change',function(){
    filename = this.value.split("\\").slice(-1);
    $(this).siblings(".custom-file-label").addClass("selected").html(filename);
})

{% if data_pages %}
    var table = $("#table-copies-pages").DataTable( {
            scrollY: '55vh',
                "dom": 'rtip',
            "lengthChange": false,
            "paging": false
        } );

    //var filtered_questions_list=[];
    //var question_filter_id=0;
    //var question_filter_name='All';
    //var type_filter='All';
    var curr_selected_id = "table-scan-row-1-1";
    //var canvasScan = document.getElementById("canvasScan");
    //var imgScan = new Image();
    initCopyPagesTableOnClickRowEvent(true);
    $("#table-copies-pages tbody tr:first").trigger('click');
{% endif %}


function initCopyPagesTableOnClickRowEvent(refresh){

    $("#table-copies-pages tbody").on('click', 'tr', function () {
        $(document.getElementById(curr_selected_id)).css('background','');
        $(this).css('background', 'yellow');
        //get_amc_marks_positions(this.cells[0].innerText,this.cells[1].innerText,this.cells[4].innerText);
        curr_selected_id=this.id;
    });

    if(!refresh){
        var table = $("#table-copies-pages").DataTable( {
            scrollY: '40vh',
            "dom": 'rtip',
            "lengthChange": false,
            "paging": false
        } );
    }
}

const amcScansFromLocalFrm = document.getElementById("amcScansFromLocalFrm");

amcScansFromLocalFrm.addEventListener("submit", (e) => {
    e.preventDefault();
    callAutomaticDataCapture();
})

function callAutomaticDataCapture(){
    $("#closeConfirmAutomaticDataCaptureModalBt").click();
    frmData = new FormData($("#amcScansFromLocalFrm")[0])
    frmData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    frmData.append('exam_pk', {{ exam.pk }});
    $('#loadingModal').modal('show');
    $.ajax({
        url: "{% url 'call_amc_automatic_data_capture' %}",
        type: "POST",
        data : frmData,
        contentType: false,
        processData: false,
        success: (data) => {    
            //todo
        },
        error: (error) => {
            console.log(error);
        },
        complete : function(){  
            $('#loadingModal').modal('hide');
        }
    });  
}

function showErrorDataCaptureDialog(title){    
    data = '';
    switch (title) {
        case 'Missing pages':
        {
            {% for copy in missing_pages %}
              {% for page in copy.missing_pages %}
                  data += '{{ copy.copy_no }} / {{ page }}'
                  data += '<br/>'
              {% endfor %}
            {% endfor %}   
            break;         
        }
        case 'Unrecognized pages':
        {
            {% for page in unrecognized_pages %}
              data += '{{ page }}'
              data += '<br/>'
            {% endfor %}  
            break;            
        }
        case 'Overwritten pages':
        {
            {% for page in overwritten_pages %}
              data += 'Copy {{ page.student }} / Page {{ page.page }} / Modified : {{ page.timestamp_auto|print_timestamp }}'
              data += '<br/>'
            {% endfor %}  
            break;           
        }
    }
    document.getElementById("errorDataCaptureDialogTitle").innerText =  title;
    document.getElementById("errorDataCaptureDialogData").innerHTML = data;
    
    $('#errorDataCaptureDialog').modal('show');
    
    
}

function openCopyPageZoomsDialog(copy,page){
    $.ajax({
        url: "{% url 'get_amc_zooms' %}",
        type: "POST",
        data : {
            'csrfmiddlewaretoken' : "{{ csrf_token }}",
            'exam_pk' : {{ exam.pk }},
            'copy' : copy,
            'page' : page},
        success: (data) => {
            var zoom_data = JSON.parse(data)
            //create table rows with 5 columns
            var tableBodyUnchecked = document.getElementById("ZoomUncheckedBoxesTBody");
            var tableBodyChecked = document.getElementById("ZoomCheckedBoxesTBody")
            colChecked = 0;
            colUnchecked = 0
            var trChecked = document.createElement('tr');
            var trUnchecked = document.createElement('tr')
            zoom_data.forEach(function (item) {
                var image = new Image();
                image.src = 'data:image/png;base64,'+item.imagedata;
                var td = document.createElement('td');
                td.appendChild(image);
                td.appendChild(document.createTextNode(item.bvalue.toFixed(3)));

                if( (item.black > 0 && item.manual === -1) || item.manual === 1){
                    colChecked ++;
                    if(colChecked > 5){
                        tableBodyChecked.appendChild(trChecked);
                        trChecked = document.createElement('tr');
                        colChecked = 1
                    }
                    trChecked.appendChild(td)
                }else{
                    colUnchecked ++;
                    if(colUnchecked > 5){
                        tableBodyUnchecked.appendChild(trUnchecked);
                        trUnchecked = document.createElement('tr');
                        colUnchecked = 1
                    };
                    trUnchecked.appendChild(td)
                }

            });
            if(colChecked<=5){
               tableBodyChecked.appendChild(trChecked)
            }
            if(colUnchecked<=5){
               tableBodyUnchecked.appendChild(trUnchecked)
            }
            $('#zoomDataCaptureDiagnosisDialog').modal('show');

            document.getElementById("zoomDataCaptureDiagnosisDialogHeader").innerHTML = 'Boxes zooms for <br/> Copy'+copy+' / Page '+page;
        },
        error: (error) => {
            console.log(error);
        },
        complete : function(){
        }
    });
}

</script>




